<?php

/**
 * @file
 * Primary module hooks for Advanced permissions request module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function advanced_permissions_request_form_user_form_alter(&$form) {
  // Check if config form has any value.
  $rolesToOffer = \Drupal::config('advanced_permissions_request.settings')->get('roles_to_offer');

  // Check user roles, if is admin, donÂ´t show button.
  $rolesLoguedUser = implode(",", \Drupal::currentUser()->getRoles());
  $userId = \Drupal::currentUser()->id();

  // Check if user has any roleRequeste openned.
  $requestPending = \Drupal::service('advanced_permissions_request.service')->checkUserRolesRequest($userId);

  if ($rolesToOffer != NULL && !str_contains($rolesLoguedUser, 'administrator') && !is_array($requestPending)) {
    $mesage = "<a class='button button--primary' href=/user/" . $userId . "/request-roles>Request new roles</a>";
  }
  elseif (is_array($requestPending)) {
    $mesage = "<a class='wt-link wt-ecl-button wt-ecl-button--primary' href=/advanced-permissions-request/" . $requestPending["nid"] . "/denny>You have pending old request to " . $requestPending["role"] . ", do you want to cancel</a>";
  }

  $form['request_role'] = [
    '#type' => "markup",
    '#markup' => $mesage,
    '#weight' => -100,
  ];

}

/**
 * Implements hook_element_info_alter().
 */
function advanced_permissions_request_element_info_alter(array &$types) {
  // Attach our extra CSS for toolbar icons.
  if (isset($types['toolbar'])) {
    $types['toolbar']['#attached']['library'][] = 'advanced_permissions_request/roles';
  }
}

/**
 * Implements hook_mail().
 */
function advanced_permissions_request_mail($key, &$message, $params) {
  switch ($key) {
    case 'request_role':
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['message'];
      break;
  }
}
